<!--   In-page Table of Contents staging  -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 2, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top
  $(window).scrollTop(scroll_target - 0);
  return false
})

});
</script>
<!-- end of in-page TOC staging -->


<!--   In-page page-navigation buttons  -->
{% unless page.pagenav == false %}
                                                                                        <p> Start Debug output (get rid of me later) </p>
  <!-- Create previous/next in-page navigation buttons. -->
  <!-- Figure out what the terminal-index-level of the current page is (as "mylevel") -->
  {% for i in (1..7) %}
    {% assign lvlvar = "l" | append: i | append: "idx" %}
    {% if page[lvlvar] %}
      {% assign myidx = page[lvlvar] %}
      {% assign mylvl = forloop.index | plus: 0 %}
    {% endif %}
  {% endfor %}

{% assign mylvl-int = mylvl | to_i %}
{% assign myidx-int = myidx | to_i %}
{% assign parentlvl = '' | plus: 0 %}
{% assign parentlvl = mylvl | minus: 1 %}
<p> myidx: {{myidx-int}}.   mylvl: {{mylvl}}.  parentlvl: {{parentlvl}} </p>

  <!--  Create collection of "adjacent" pages to this one. -->
  

<!-- So, how do a mutate the pages hash into a new hash while programmatically *naming* the new hash?  I can select elements of the existing hash
programmatically, using square-brackets to substitutute variables into the hash structure, but can't *create* hashes that way.  Maybe pre-define the hashes?
-->

{% assign pagearray = site.emptyArray %}
{% assign pagearray = site.emptyArray %}
{% for apage in site.pages %}
  {% assign pagearray = pagearray | push: apage %}
{% endfor %}
<p> pagearray:  {{pagearray | size }}</p>

<!--Create an array containing each page's data (pagearray).
Loop through the index-hierarchies (1-7)
  Loop through pagearray.
    If a page in pagearray matches the l1idx filter, append its index to an array called indexmatches[pagearray.forloopindex]
-->

{% assign lvlidxmatches = '','','','','','',''' | split: ',' %}

{% assign tmp2 = site.emptyArray %}
{% for blob in site.pages[3] | jsonify %}
  {% assign tmp2 = tmp2 | push: blob %}
{% endfor %}

{% for bit in tmp2 %}
<p> Fld({{forloop.index}}): {{bit}}</p>
{% endfor %}


<p>{{ site.pages[3] | jsonify }} </p>
                                                                                            <p> End Debug output (get rid of me later) </p>





  <!-- Get a list of all the page-numbers and their URLs for pages in the same library/document/chapter as the current page -->
  {% assign fullpages = site.pages | where: 'libname', page.libname | where: 'docname', page.docname | where: 'chapnum', page.chapnum, | sort: 'pagenum' %}
  {% assign pagenums = site.pages | where: 'libname', page.libname | where: 'docname', page.docname | where: 'chapnum', page.chapnum, | sort: 'pagenum' | map: 'pagenum' | uniq | compact %}
  {% assign pagecount = site.pages | where: 'libname', page.libname | where: 'docname', page.docname | where: 'chapnum', page.chapnum, | sort: 'pagenum' | map: 'pagenum' | uniq | compact | size  %}
  {% if pagecount > 1 %}
    {% assign hostpagenum = page.pagenum | plus: 0  %}
    {% assign hostpagenumint = page.pagenum | to_i  %}
    {% assign oneless = '' | plus: 0 %}
    {% assign onemore = '' | plus: 0 %}
    {% assign oneless = hostpagenumint | minus: 1 %}
    {% assign onemore = hostpagenumint | plus: 1 %}
    <div class="seriesContext">
      {% for pnumval in pagenums %}
        {% assign flpagenum = pnumval | plus: 0  %}
        {% if flpagenum == oneless %}
          <a href="{{fullpages[forloop.index0].url | remove: '/'}}"><button type="button" class="btn">Previous Page </button></a>
        {% endif %}
        {% if flpagenum == onemore %}
          <a href="{{fullpages[forloop.index0].url | remove: '/'}}"><button type="button" class="btn">Next Page </button></a>
        {% endif %}
      {% endfor %}
      {% if pagecount > 2 %}
        <div class="btn-group">
          <button type="button" data-toggle="dropdown" class="btn dropdown-toggle;">Jump to page <span class="caret"> </span></button>
          <ol class="dropdown-menu">
            {% for pnumval in pagenums %}
              {% assign flpagenum = pnumval | plus: 0  %}
              {%if flpagenum == hostpagenum %}
                <li class="active">â†’{{fullpages[forloop.index0].pagenum}}.{{fullpages[forloop.index0].title}}</li>
              {% else %}
                <li>
                  <a href="{{fullpages[forloop.index0].url | remove: '/'}}">{{fullpages[forloop.index0].pagenum}}. {{fullpages[forloop.index0].title}}</a>
                </li>
              {% endif %}
            {% endfor %}
            </ol>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endunless %}
<!--   End of in-page page-navigation buttons  -->



{% unless page.toc == false %}
  {% assign tmparray = page.content | markdownify | split: '</h2>' | size %}
  {% if tmparray > 2 %}
    <details><summary >Table of Contents</summary><div id="toc"></div></details>
  {% endif %}
{% endunless %}
