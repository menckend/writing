<!--
lvl1 = topnav button name (e.g. "articles" or "books")
lvl2 = sidebar name (same as topnav dropdown list entry, (e.g. "book 1" or "article 2")
lvl3 = 1st level of entries in sidebar  (eg section or chapter)
lvl4 = 2nd level of entries in sidebar  (eg chapter or page )
lvl5 = 3rd level of entries in sidebar  (e.g  page or sub-page)
-->

<div class="medianav">
{% include social_media_icons.html %}
</div>
<!-- <div class="mydocsidebar"> -->
   <div class="mencknav">
      {% unless page.url contains 'index.html' %}




<!-- Move this variable to site-data later -->
{% assign maxdepth = 10 | plus: 0 %}

<!--  Start the new stuff  -->

<!--  Get the title of the "l2" parent page of the current page.
{% assign ourpages = site.pages | where: 'l1idx', page.l1idx | where: '12idx', page.12idx%}
{% for pg in ourpages %}
{% unless pg.l3idx %}
<div class="productTitle" style="padding-top: 32px;"><p>{{pg.l2idx}}</p></div>
{% endunless %}
{% endfor %}

<!--  Build arrays of the page-date we need to build our tree.
{% assign opgs_position = '' | split: ',' %}
{% assign opgs_urls = '' | split: ',' %}
{% assign opgs_names = '' | split: ',' %}
{% assign opgs_lvls = '' | split: ',' %}
{% assign opgs_idxes = '' | split: ',' %}

{% for pg in ourpages %}
   {% assign opgs_position = opgs_position | push: forloop.index0 %}
   {% assign opgs_urls = opgs_urls | push: pg.url %}
   {% assign opgs_names = opgs_title | push pg.title %}
   {% assign lvlbldr = '' %}
   {% assign idxbldr = '' %}
   {% for i in (3..maxdepth) %}
      {% assign lvllabel = 'l | append: i | append: | 'idx' %}
      {% assign lvlbldr = lvlbldr | append: lvllabel | append ',' %}
      {% assign idxbldr = idxbldr | append: pg[lvllabel] | append: ','}
   {% endfor %}
   {% assign opgs_lvls = opgs_lvls | append: lvlbldr}
   {% assign opgs_idxes = opgs_idxes | append: idxbldr}
{% endfor %}

<!--  Loop through our arrays of page-data in order to build our tree.

{% for j in (3..maxdepth) %}

get ourpages indices for lvlJ pages



{% endfor %}














  <!-- Figure out what the terminal-index-level of the current page is (as "mylevel") -->
  {% for i in (1..10) %}
    {% assign lvlvar = "l" | append: i | append: "idx" %}
    {% if page[lvlvar] %}
      {% assign myidx = page[lvlvar] %}
      {% assign mylvl = forloop.index %}
    {% endif %}
  {% endfor %}
  {% assign lvlvar = "l" | append: mylvl | append: "idx" %}
  {% assign mylvl-int = mylvl | to_i %}
  {% assign myidx-int = myidx | to_i %}
  {% assign parentlvl = '' | plus: 0 %}
  {% assign parentlvl = mylvl-int | minus: 1 %}
  {% assign nextlvl = mylvl-int | plus: 1 %}
  <!-- <p> myidx: {{myidx-int}}.   mylvl: {{mylvl}}.  parentlvl: {{parentlvl}} </p>  -->
  <!--  Create collection of "adjacent" pages to this one. -->  
  {% assign ngbr_pgs = '' | split: ',' %}
  {% assign ngbr_urls = '' | split: ',' %}
  {% assign ngbr_idxes = '' | split: ',' %}
  <!-- Loop through all the pages in the site -->
  {% for cpg in site.pages %}
    <!-- Start by assuming that each page in site.pages *is* a neighbor page for the current page -->
    {% assign goodpage = 'true' %}
    <!-- Loop through the page-hierarchy levls from 1 up to the parent-level of the active page -->
    {% for i in (1..parentlvl) %}
      {% if goodpage == 'true' %}
        {% assign cmpvar = 'l' | append: i | append: 'idx' %}
        {% if cpg[cmpvar] %}
          {% if cpg[cmpvar] != page[cmpvar] %}
            <!-- Mark the looped page as "not a neighbor", because one of the higher-levels in the hierarchy has a different value than the active page -->
            {% assign goodpage = 'false' %}
          {% endif %}
        {% else %}
          <!-- Mark the looped page as "not a neighbor", because it doesn't even *have* an index for for one higher levels in the hierarchy.  -->
        {% assign goodpage = 'false'%}
        {% endif %}
      {% endif %}
    {% endfor %}
    <!-- Loop through the page-hierarchy levls from the active-page's child-level to the deepest level (10, for now) -->
    {% for k in (nextlvl..10) %}
      {% if goodpage == 'true' %}
        {% assign cmpvar = 'l' | append: k | append: 'idx' %}
        {% if cpg[cmpvar] %}
          {% assign goodpage = 'false' %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {% if goodpage == 'true' %}
      {% assign mystr = 'l' | append: mylvl | append: 'idx' %}
      {% assign myval = page[mystr] %}
      {% assign yourval = cpg[mystr] %}
      {% if myval == yourval %}
        {% assign goodpage = 'false' %}
      {% endif %}
    {% endif %}
    <!-- mark the "parent-page"  of the current page as "not a neighbor"  -->
    {% if goodpage == 'true' %}
      {% assign str_aa = 'l' | append: parentlvl | append: 'idx' %}
      {% assign str_bb = 'l' | append: mylvl | append: 'idx' %}
      {% if cpg[str_aa] %}
        {% unless cpg[str_bb] %}
          {% assign goodpage = 'false' %}
        {% endunless %}
      {% endif %}
    {% endif%}
    {% if goodpage == 'true' %}
      {% assign ngbr_pgs = ngbr_pgs | push: forloop.index0 %}
      {% assign ngbr_urls = ngbr_urls | push: cpg.url %}
      {% assign ngbr_idxes = ngbr_idxes | push: cpg[str_bb] %}
    {% endif %}
  {% endfor %}

  <!-- Figure out the previous and next pages' site.pages' URLs, for use in the navigation buttons -->
  {% assign ngct = ngbr_pgs | size | minus: 1 %}

  {% assign lvlvar = "l" | append: mylvl | append: "idx" %}
  {% assign prvidx = myidx | minus: 1 %}
  {% assign nxtidx = myidx | plus: 1 %}

  {% for xray in (0..ngct) %}
    {% if ngbr_idxes[forloop.index0] == prvidx %}
      {% assign prvurl = ngbr_urls[forloop.index0] %}
    {% endif %}
    {% if ngbr_idxes[forloop.index0] == nxtidx %}
      {% assign nxturl = ngbr_urls[forloop.index0] %}
    {% endif %}
  {% endfor %}



<!--   End the new stuff  -->

















<!--   BEGIN:  The old way -->

<!--         {% assign sbtitle = site.pages | where: 'l1idx', page.l1idx | where: 'l2idx', page.l2idx | map: 'l2name' | compact | uniq %}
         <div class="productTitle" style="padding-top: 32px;"><p>{{sbtitle}}</p></div>
      {% endunless %}
      {% unless page.url contains 'index.html' %}

-->

            <!-- Get a list of all pages with l1/l2 index values that match *this* page.  (these are *all* the pages that should be in the sidebar)  -->
            {% assign ourpages = site.pages | where: 'l1idx', page.l1idx | where: 'l2idx', page.l2idx | where: '12name', null %}
            <!-- start building the tree if there *are* any other pages that match *this* page's l1|2 index values. -->
            {% if ourpages.size > 0 %}
               <!-- Get a list of all the unique/sorted l3 indices from sbpages -->
               {% assign ourl3idxes = ourpages | where_exp: 'page', 'page.l3name' | sort: 'l3idx' | map: 'l3idx' %}
               <!-- Loop through all the unique L3 indices and create the first level entries in the sidebar menu -->
               {% if ourl3idxes.size > 0 %}
                  {% for l3ix in ourl3idxes %}
                     <!-- Get a list of all the pages with *current* L3 index -->
                     {% assign myl3pages = ourpages | where: 'l3idx', l3ix | sort: 'l3idx' %}
                     <!-- set variables for the l3name and url value that corresponds to the l3index value of the current iteration of the loop -->
                     {% assign myl3name = myl3pages | where: 'l3idx', l3ix | where_exp: 'page', 'page.l3name' | map: 'l3name'%}
                     {% assign myl3url = myl3pages | where: 'l3name', myl3name[0] | map: 'url' | array_to_sentence_string %}
                     <!-- Get all the unique L4 indices in pages with *current* L3 index -->
                     {% assign myl4idxes = myl3pages | where_exp: 'page', 'page.l4name' | sort: 'l4idx' | map: 'l4idx' %}
                     <!-- Testing to see if the current l3 index has any l4 children. -->
                     {% if myl4idxes.size > 0 %}
                        <details class="sbdeet" {% if page.l3idx == l3ix%}open{%endif%}><summary><a title="{{myl3name}}" href="{{myl3url | remove: '/'}}">{{myl3name}}</a></summary>
                           {% for l4ix in myl4idxes %}
                              <!-- Get a list of all the pages with *current* L4 index -->
                              {% assign myl4pages = myl3pages | where: 'l4idx', l4ix %}
                              {% assign myl4name = myl4pages | where: 'l4idx', l4ix | where_exp: 'page', 'page.l4name' | map: 'l4name' %}
                              {% assign myl4url  = myl4pages | where: 'l4name', myl4name[0] | map: 'url' | array_to_sentence_string %}
                              <!-- Get all the unique L5 indices in pages with *current* L3&L4 index -->
                              {% assign myl5idxes = myl4pages | where_exp: 'page', 'page.l5name'| map: 'l5idx' %}
                              {% if myl5idxes.size > 0 %}
                                 <details class="sbdeet deet4" {% if page.l4idx == l4ix and page.l3idx == l3ix %} open{%endif%}><summary><a title="{{myl4name}}" href="{{myl4url | remove: '/'}}">{{myl4name}}</a></summary>
                                    {% for l5ix in myl5idxes %}
                                       {% assign myl5name = myl4pages | where: 'l5idx', l5ix | map: 'l5name' %}
                                       {% assign myl5url = myl4pages | where: 'l5name', myl5name[0] | map: 'url' %}
                                       <p class="l5item{% if page.l5idx == l5ix and page.l4idx == l4ix and page.l3idx == l3ix %}active{%endif%}"><a title="{{myl5name}}" href="{{myl5url[0] | remove: '/'}}">{{myl5name}}</a></p>
                                    {% endfor %}
                                 </details>
                              {% else %}
                                 <p class="l4item{% if page.l4idx == l4ix and page.l3idx == l3ix %}active{% endif %}"><a title="{{myl4name}}" href="{{myl4url | remove: '/'}}">{{myl4name}}</a></p>
                              {% endif %}
                           {% endfor %}
                        </details>
                     {% else %}
                        <p class="l3item{% if page.l3idx == l3ix %}active{% endif %}"><a title=" {{myl3name}}" href="{{myl3url | remove: '/'}}">{{myl3name}}</a></p>
                     {% endif %}
                  {% endfor %}
               {% else %}
                  <p> Nothing here yet; check back later</p>
               {% endif %}
            {% else %}
               <p> Nothing here yet; check back later</p>
            {% endif %}   
<!--   END:  The old way -->









      {% endunless %}
   </div>
<!-- </div> -->
